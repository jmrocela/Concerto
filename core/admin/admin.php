<?php/*! * Concerto - a fresh and new wordpress theme framework for everyone * * http://themeconcert.com/concerto * * @version: 1.0 * @package: ConcertoAdmin * * [WARNING] * This is restricted file and should not be modified in any way(unless you know what * you are doing). This file serves as the Base Class for setting up administration pages. */class ConcertoAdmin {	/**	 * Constructor	 *	 * Require the files needed and hook what's needed to Wordpress	 *	 * @return void	 */	public function __construct() {		global $extensions, $stage;		$stage = get_option('concerto_stage');				// Require the individual Administration Pages		require_once CONCERTO_ADM . 'general.php';		require_once CONCERTO_ADM . 'design.php';		require_once CONCERTO_ADM . 'tools.php';		require_once CONCERTO_ADM . 'support.php';				// Hook boxes to their assigned places		require_once CONCERTO_ADM . 'actions.php';				// Load Extensions and Stages		$extensions->load();				// Bind Concerto to Wordpress		add_action('admin_init', array($this, 'init'));		add_action('admin_menu', array($this, 'menu'));	}	/**	 * Init	 *	 * Hooked to admin_init. Sets up the scripts and nonce for use in the admin.	 * Registers the settings and passes the upload	 *	 * @return void	 */	public function init() {		// We Include our Javascript Files		$stylesheet_directory = get_bloginfo('stylesheet_directory');		wp_register_script('jQueryMasonry', $stylesheet_directory . '/core/scripts/jquery.masonry.js', null, CONCERTO_VERSION);		wp_register_script('jQuerySWFUpload', $stylesheet_directory . '/core/scripts/jquery.swfupload.js', null, CONCERTO_VERSION);		wp_register_script('concertoAdmin', $stylesheet_directory . '/core/scripts/concerto.admin.js', null, CONCERTO_VERSION);		wp_enqueue_script('jQueryMasonry');		wp_enqueue_style('concertoAdmin', $stylesheet_directory . '/core/admin/style.css');				// Attach ajax functionality		add_action('wp_ajax_pinglicense', array($this, 'license'));				// Check if we have valid configurations for our Stage		global $stage;		if (!get_option('concerto_' . $stage . '_design_html_version')) {			require_once CONCERTO_LIBS . 'defaults.php';			defaultOptions($stage, null, true);		}				if (is_plugin_page()) {			if ($_GET['page'] == 'concerto_admin_menu' || $_GET['page'] == 'concerto_admin_design' || $_GET['page'] == 'concerto_admin_tools') {				wp_enqueue_script('swfupload');				wp_enqueue_script('jQuerySWFUpload');				wp_enqueue_script('concertoAdmin');			}			if ($_GET['page'] == 'concerto_admin_menu' || $_GET['page'] == 'concerto_admin_design') {				wp_enqueue_script('jquery-ui-sortable', null, array('jquery-ui-core'));			}			if ($_GET['page'] == 'concerto_admin_design') {				wp_enqueue_script('farbtastic');				wp_enqueue_style('farbtastic');			}			if ($_GET['page'] == 'concerto_admin_tools') {				if (!empty($_POST['concerto_exportconfig_nonce']) || !empty($_POST['concerto_restoreconfig_nonce']) || !empty($_POST['concerto_newstage_nonce'])) {					require_once 'functions.php';					$context = array();					if (!empty($_POST['concerto_tools_export_from'])) {						if (wp_verify_nonce($_POST['concerto_exportconfig_nonce'], 'concerto_exportconfig')) {							if (@$_POST['concerto_tools_export_general'] == 1) $context[] = 'general';							if (@$_POST['concerto_tools_export_design'] == 1) $context[] = 'design';							$stage = $_POST['concerto_tools_export_from'];							if (!empty($context)) {								exportConcertoOptions($stage, $context);							}						}					}					if (!empty($_POST['concerto_tools_restore_from'])) {						if (wp_verify_nonce($_POST['concerto_restoreconfig_nonce'], 'concerto_restoreconfig')) {							if (@$_POST['concerto_tools_restore_general'] == 1) $context[] = 'general';							if (@$_POST['concerto_tools_restore_design'] == 1) $context[] = 'design';							$stage = $_POST['concerto_tools_restore_from'];							if (!empty($context)) {								restoreConcertoOptions($stage, $context);								$location = get_bloginfo('url') . '/wp-admin/admin.php?page=concerto_admin_tools&restored=1&restored_to=' . urlencode($stage) . '&restored_context=' . urlencode(implode(',', $context));								wp_redirect($location);								exit;							}						}					}										if (!empty($_POST['concerto_newstage_nonce']) && !empty($_POST['concerto_tools_stage_name'])) {						if (wp_verify_nonce($_POST['concerto_newstage_nonce'], 'concerto_newstage')) {							$stage = $_POST['concerto_tools_stage_name'];							$code = createStage($stage);							if ($code == 1) {								$location = get_bloginfo('url') . '/wp-admin/admin.php?page=concerto_admin_tools&stage_created=' . urlencode($stage);							} else {								$location = get_bloginfo('url') . '/wp-admin/admin.php?page=concerto_admin_tools&code=' . $code . '&stage=' . urlencode($stage);							}							wp_redirect($location);							exit;						}					}				}			}		}				// Handle the Uploads for the Favicon, Header Images, Configuration Files and Stage Archives		if (@$_FILES['CONCERTO_UPLOAD']) {			$this->upload();			die();		} else if (!isset($_POST['_concerto_nonce']) && get_option('concerto_upload_nonce_made') != 1) { 			// Create a nonce for swfupload			update_option('concerto_upload_nonce', md5(microtime()));			update_option('concerto_upload_nonce_made', 1);		}				// We Register Options		$this->registerSettings();	}	/**	 * Menu	 *	 * Binds menus to the Concerto Admin Dashboard	 *	 * @return void	 */	public function menu() {		global $menu;		$menu[99] = array('', 'read', 'separator-concerto', '', 'wp-menu-separator');			add_menu_page(__('General', 'concerto'), __('Concerto', 'concerto'), 'switch_themes', 'concerto_admin_menu', 'admin_general', null, 100);		add_submenu_page('concerto_admin_menu', __('Concerto - General', 'concerto'), __('General', 'concerto'), 'switch_themes', 'concerto_admin_menu', 'admin_general');		add_submenu_page('concerto_admin_menu', __('Concerto - Design', 'concerto'), __('Design', 'concerto'), 'switch_themes', 'concerto_admin_design', 'admin_design');		add_submenu_page('concerto_admin_menu', __('Concerto - Tools', 'concerto'), __('Tools', 'concerto'), 'switch_themes', 'concerto_admin_tools', 'admin_tools');		add_submenu_page('concerto_admin_menu', __('Concerto - Support', 'concerto'), __('Support', 'concerto'), 'switch_themes', 'concerto_admin_support', 'admin_support');	}	/**	 * Register Settings	 *	 * Registers settings for option pages in Concerto	 *	 * @return void	 */	public function registerSettings() {		require_once CONCERTO_ADM . 'settings.php';		do_action('concerto_admin_settings');	}	/**	 * Upload	 *	 * Handles the Upload for Favicon, Header, Configuration or Stage files	 *	 * @return void	 */	public function upload() {		if ($_POST['_concerto_nonce'] == get_option('concerto_upload_nonce')) {			update_option('concerto_upload_nonce_made', 0);		} else {			return false;		}		if ($_POST['concerto_action'] == 'importconfig') {			require_once 'functions.php';			$overrides = array('test_form' => false, 'mimes' => array('json' => 'text/json', 'cfwconf' => 'text/json'));			$file = wp_handle_upload($_FILES['CONCERTO_UPLOAD'], $overrides);			echo (importConcertoOptions($file['file'], $_POST['stage'])) ? '1': 'ERROR:not a configuration file';		}		if ($_POST['concerto_action'] == 'newstage') {			require_once 'functions.php';			$overrides = array('test_form' => false, 'mimes' => array('zip' => 'application/zip', 'tar.gz' => 'application/x-gzip'));			$file = wp_handle_upload($_FILES['CONCERTO_UPLOAD'], $overrides);			$name = explode('.', $_FILES['CONCERTO_UPLOAD']['name']); //watch out!			$name = $name[0];			$code = createStage($name, $file['file']);			echo ($code == 1) ? $name: $code;		}		if ($_POST['concerto_action'] == 'favicon' || $_POST['concerto_action'] == 'header') {			$overrides = array('test_form' => false);			$file = wp_handle_upload($_FILES['CONCERTO_UPLOAD'], $overrides);			echo $file['url'];		}		die();	}}?>